from django.shortcuts import render, redirect
from django.core.mail import send_mail
from .forms import EtudiantForm
from django.conf import settings
from django.utils.html import strip_tags



def inscription_etudiant(request):
    if request.method == 'POST':
        form = EtudiantForm(request.POST)
        if form.is_valid():
            etudiant = form.save()

            # Corps du message complet
            message_html = f"""
            <!DOCTYPE html>
            <html lang="fr">
            <head>
                <meta charset="UTF-8">
                <style>
                    body {{
                        font-family: 'Segoe UI', Tahoma, sans-serif;
                        color: #333;
                        background-color: #f9f9f9;
                        padding: 20px;
                    }}
                    .container {{
                        max-width: 600px;
                        margin: auto;
                        background: white;
                        border-radius: 10px;
                        padding: 30px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    }}
                    h2 {{
                        color: #2c3e50;
                    }}
                    ul {{
                        padding-left: 20px;
                    }}
                    .highlight {{
                        background-color: #eaf4ff;
                        padding: 8px;
                        border-left: 4px solid #3498db;
                        margin: 10px 0;
                    }}
                    .footer {{
                        font-size: 0.9rem;
                        color: #666;
                        margin-top: 20px;
                        text-align: center;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h2>Bonjour {etudiant.prenom} {etudiant.nom} ,</h2>
                    <p>üéâ <strong>F√©licitations !</strong> Votre inscription √† l‚ÄôAide Alimentaire √âtudiante du Havre est bien enregistr√©e.</p>
                    <p><strong>Votre symbole : {etudiant.symbole.nom} {etudiant.symbole.icone} </strong> </p>

                    <div class="highlight">
                        <strong>üìç Activation sur place :</strong><br>
                        Salle Mandarine, Secours Catholique<br>
                        54 rue Michelet ‚Äì Le Havre<br>
                        <strong>Le jeudi 3 octobre 2024 √† partir de 16h30</strong>
                    </div>

                    <p>üìÖ Si vous ne pouvez pas venir √† cette date, vous pouvez valider votre inscription aux dates suivantes, d√®s 17h30 :</p>
                    <ul>
                        <li>Jeudi 17 octobre 2024</li>
                        <li>Jeudi 24 octobre 2024</li>
                        <li>Jeudi 14 novembre 2024</li>
                        <li>Jeudi 28 novembre 2024</li>
                        <li>Jeudi 12 d√©cembre 2024</li>
                        <li>Jeudi 19 d√©cembre 2024</li>
                        <li>Jeudi 9 janvier 2025</li>
                        <li>Jeudi 23 janvier 2025</li>
                        <li>Jeudi 6 f√©vrier 2025</li>
                        <li>Jeudi 27 f√©vrier 2025</li>
                        <li>Jeudi 6 mars 2025</li>
                        <li>Jeudi 20 mars 2025</li>
                        <li>Jeudi 3 avril 2025</li>
                        <li>Jeudi 24 avril 2025</li>
                        <li><strong>Mercredi 30 avril 2025</strong> (exceptionnellement)</li>
                        <li>Jeudi 15 mai 2025</li>
                        <li>Jeudi 5 juin 2025</li>
                    </ul>

                    <p>üìå  <strong>symbole de passage : </strong> {etudiant.symbole.nom} {etudiant.symbole.icone}   qui restera le m√™me durant toutes vos √©tudes au Havre. Il vous servira pour conna√Ætre votre ordre de passage √† chaque distribution.</p>

                    <p>üîî Cet ordre de passage est publi√© la veille sur nos pages <strong>Facebook et Instagram : Young Caritas LH</strong>.</p>

                    <div class="highlight">
                        <strong>üéí √Ä apporter √† chaque distribution :</strong><br>
                        - Votre carte d‚Äô√©tudiant<br>
                        - Une participation de <strong>4,10 ‚Ç¨</strong> (en petite monnaie)<br>
                        - Un grand sac cabas + un sac isotherme (obligatoire pour les surgel√©s)
                    </div>

                    <p>üôå Notre √©quipe de b√©n√©voles Young Caritas vous accueillera avec le sourire pour vous expliquer le d√©roulement et r√©pondre √† vos questions.</p>

                    <p>‚ú® Tr√®s belle ann√©e universitaire au Havre et √† tr√®s bient√¥t !</p>

                    <div class="footer">
                        ‚Äî L‚Äô√©quipe des Young Caritas du Havre & l‚ÄôAum√¥nerie √âtudiante ‚Äî
                    </div>
                </div>
            </body>
            </html>
            """

            # Envoie de l'email avec HTML :
            send_mail(
                subject="Bienvenue ! Votre inscription est confirm√©e",
                message=strip_tags(message_html),  # version texte simple fallback
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[etudiant.email],
                html_message=message_html
            )

            return render(request, 'inscription/succes.html')
    else:
        form = EtudiantForm()
    return render(request, 'inscription/inscription.html', {'form': form})


def accueil(request):
    return render(request, 'inscription/accueil.html')
